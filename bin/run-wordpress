#!/usr/bin/env bash

# Usage: bin/run-wordpress [WORDPRESS_VERSION] [PHP_VERSION]
# Example: bin/run-wordpress 67 82

# Run WP CLI as user 33
# https://github.com/docker-library/docs/tree/master/wordpress#running-as-an-arbitrary-user

# Ensure Docker CLI is installed.
if ! command -v docker >/dev/null; then
  echo "Docker CLI is required."
  exit 1
fi

# Parse versions (args override env vars, defaults provided)
WORDPRESS_VERSION_ENV="${1:-$WORDPRESS_VERSION}"
PHP_VERSION_ENV="${2:-$PHP_VERSION}"

: "${WORDPRESS_VERSION_ENV:=latest}"    # default WordPress version shorthand
: "${PHP_VERSION_ENV:=8.0}"             # default PHP version shorthand

# Default WordPress port (80 + version shorthand)
: "${WORDPRESS_PORT:=80${WORDPRESS_VERSION_ENV}}"
export WORDPRESS_PORT

# Convert shorthand version into full version format (dotted) for image tags
if [[ "$WORDPRESS_VERSION_ENV" =~ ^[0-9]{2}$ ]]; then
  WORDPRESS_VERSION="${WORDPRESS_VERSION_ENV:0:1}.${WORDPRESS_VERSION_ENV:1:1}"
else
  WORDPRESS_VERSION="$WORDPRESS_VERSION_ENV"
fi
export WORDPRESS_VERSION

if [[ "$PHP_VERSION_ENV" =~ ^[0-9]{2}$ ]]; then
  PHP_VERSION="${PHP_VERSION_ENV:0:1}.${PHP_VERSION_ENV:1:1}"
else
  PHP_VERSION="$PHP_VERSION_ENV"
fi
export PHP_VERSION

echo "Starting Docker environment with WordPress $WORDPRESS_VERSION and PHP $PHP_VERSION..."
docker compose -f config/docker-compose.yml up -d

## Install WordPress via WP-CLI container
echo "Installing WordPress..."

docker compose -f config/docker-compose.yml run --rm --user 33 wpcli bash -c "
  until wp db check --allow-root; do
    echo 'DB not ready yet..'
    sleep 2
  done &&

  if [ ! -f wp-config.php ]; then
    wp config create --dbname=wordpress --dbuser=wordpress --dbpass=wordpress --dbhost=db --allow-root
  fi &&

  wp db create --allow-root 2>/dev/null || true &&

  export WORDPRESS_PORT=${WORDPRESS_PORT} && \
  wp core install \
    --url=http://localhost:\${WORDPRESS_PORT} \
    --title='My Site' \
    --admin_user=admin \
    --admin_password=password \
    --admin_email=wordpress@example.com \
    --skip-email \
    --allow-root
"

echo "Activating tinify.."
docker compose -f config/docker-compose.yml run --rm wpcli wp plugin activate tiny-compress-images --allow-root

if [ "$WORDPRESS_VERSION_ENV" -ge 55 ]; then
  echo "Installing compatible plugins for WordPress ${WORDPRESS_PORT}.."
  docker compose -f config/docker-compose.yml run --rm --user 33 wpcli wp plugin install amazon-s3-and-cloudfront --activate --allow-root || exit 1
fi

echo "WordPress is ready at http://localhost:${WORDPRESS_PORT} (admin/password)"
echo "To stop, run: bin/stop-wordpress"
